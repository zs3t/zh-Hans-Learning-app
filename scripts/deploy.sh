#!/bin/bash

# ==============================================================================
# Hanzi App - ç”Ÿäº§çŽ¯å¢ƒä¸€é”®éƒ¨ç½²è„šæœ¬
# è¿è¡Œæ–¹å¼:
#   1. é¦–æ¬¡éƒ¨ç½²: åœ¨æœåŠ¡å™¨ä¸Šä»»æ„ä½ç½®æ‰§è¡Œæ­¤è„šæœ¬ã€‚å®ƒä¼šå…‹éš†ä»“åº“å¹¶è®¾ç½®é¡¹ç›®ã€‚
#      ä¾‹å¦‚: bash /path/to/your/repo/scripts/deploy.sh
#   2. åŽç»­æ›´æ–°: åœ¨é¡¹ç›®æ ¹ç›®å½•å†…æ‰§è¡Œ 'bash scripts/deploy.sh' æˆ–ç›´æŽ¥åœ¨ /scripts ç›®å½•æ‰§è¡Œã€‚
#      ä¾‹å¦‚: cd /home/your-user/zh-hans-learning-app && bash scripts/deploy.sh
# ==============================================================================

# -- é…ç½® (è¯·æ ¹æ®ä½ çš„æœåŠ¡å™¨çŽ¯å¢ƒä¿®æ”¹) --
APP_NAME="zh-hans-learning-app"
GIT_REPO_URL="git@github.com:zs3t/zh-hans-learning-app.git" # ä½ çš„ Git ä»“åº“åœ°å€ (å»ºè®®ä½¿ç”¨ SSH åœ°å€)
# DEST_BASE_DIR: é¡¹ç›®å°†è¢«éƒ¨ç½²åˆ°çš„çˆ¶ç›®å½•ã€‚ä¾‹å¦‚ï¼Œé¡¹ç›®å°†åœ¨ /var/www/zh-hans-learning-app
# æˆ–è€… /home/deploy-user/zh-hans-learning-appã€‚
# è¿™æ ·æ¯ä¸ªç”¨æˆ·æˆ–çŽ¯å¢ƒå¯ä»¥è‡ªå®šä¹‰è¿™ä¸ªåŸºç¡€ç›®å½•ã€‚
DEST_BASE_DIR="/home/$(whoami)" # é»˜è®¤å°†é¡¹ç›®éƒ¨ç½²åˆ°å½“å‰ç”¨æˆ·çš„ä¸»ç›®å½•

# PROJECT_DIR å°†ä¼šè¢«è„šæœ¬åŠ¨æ€ç¡®å®šï¼Œå®ƒä¼šæ˜¯ $DEST_BASE_DIR/$APP_NAME

# -- è„šæœ¬å¼€å§‹ --
set -e # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "ðŸš€ å¼€å§‹éƒ¨ç½² '$APP_NAME'..."

# --- ç¡®å®šé¡¹ç›®æ ¹ç›®å½• ---
# 1. é¦–å…ˆå°è¯•ä»Žå½“å‰è„šæœ¬çš„è·¯å¾„æŽ¨æ–­é¡¹ç›®æ ¹ç›®å½•
#    å¦‚æžœè„šæœ¬åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ scripts å­ç›®å½•ä¸­ï¼Œé‚£ä¹ˆé¡¹ç›®æ ¹ç›®å½•å°±æ˜¯ scripts çš„çˆ¶ç›®å½•
SCRIPT_DIR="$(dirname "$(realpath "$0")")" # èŽ·å–è„šæœ¬æœ¬èº«æ‰€åœ¨çš„ç›®å½• (ä¾‹å¦‚ /home/user/app/scripts)
# å°è¯•å‘ä¸Šè¿½è¸ªä¸€å±‚ï¼Œçœ‹çœ‹æ˜¯å¦æ˜¯é¡¹ç›®æ ¹ç›®å½•
POTENTIAL_PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# æ£€æŸ¥ POTENTIAL_PROJECT_DIR æ˜¯å¦æ˜¯å·²å­˜åœ¨çš„ Git ä»“åº“æˆ–è€…åŒ…å« package.json
if [ -d "$POTENTIAL_PROJECT_DIR/.git" ] && [ -f "$POTENTIAL_PROJECT_DIR/package.json" ]; then
    PROJECT_DIR="$POTENTIAL_PROJECT_DIR"
    echo "âœ… é¡¹ç›®ç›®å½•å·²é€šè¿‡è„šæœ¬è·¯å¾„æŽ¨æ–­ä¸º: $PROJECT_DIR"
else
    # 2. å¦‚æžœæ— æ³•æŽ¨æ–­ï¼Œåˆ™è®¤ä¸ºæ˜¯é¦–æ¬¡éƒ¨ç½²ï¼Œæˆ–è€…è„šæœ¬åœ¨é¡¹ç›®å¤–éƒ¨è¿è¡Œ
    #    æ­¤æ—¶ï¼Œé¡¹ç›®ç›®å½•å°†ç”± DEST_BASE_DIR å’Œ APP_NAME ç»„åˆè€Œæˆ
    PROJECT_DIR="$DEST_BASE_DIR/$APP_NAME"
    echo "ðŸ¤” æ— æ³•é€šè¿‡è„šæœ¬è·¯å¾„æŽ¨æ–­é¡¹ç›®ç›®å½•ã€‚å°†ä½¿ç”¨é»˜è®¤éƒ¨ç½²è·¯å¾„: $PROJECT_DIR"
fi


# 1. æ£€æŸ¥ PM2 æ˜¯å¦å®‰è£…
if ! command -v pm2 &> /dev/null
then
    echo "PM2 æœªå®‰è£…ã€‚æ­£åœ¨å…¨å±€å®‰è£… PM2..."
    npm install pm2 -g || { echo "âŒ é”™è¯¯: å®‰è£… PM2 å¤±è´¥ã€‚"; exit 1; }
fi

# 2. å‡†å¤‡é¡¹ç›®ç›®å½•å¹¶æ›´æ–°ä»£ç 
# å¦‚æžœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™ä»Ž Git å…‹éš†
if [ ! -d "$PROJECT_DIR" ]; then
    echo "é¡¹ç›®ç›®å½• '$PROJECT_DIR' ä¸å­˜åœ¨ã€‚æ­£åœ¨åˆ›å»ºçˆ¶ç›®å½•å¹¶ä»Ž Git å…‹éš†..."
    # ç¡®ä¿çˆ¶ç›®å½•å­˜åœ¨
    sudo mkdir -p "$DEST_BASE_DIR" || { echo "âŒ é”™è¯¯: åˆ›å»ºç›®æ ‡åŸºç›®å½• '$DEST_BASE_DIR' å¤±è´¥ã€‚"; exit 1; }
    # å…‹éš†å‰éœ€è¦ç¡®ä¿æƒé™ï¼Œæˆ–è€…å…‹éš†åˆ°ç”¨æˆ·å¯å†™çš„ç›®å½•ä¸‹
    git clone "$GIT_REPO_URL" "$PROJECT_DIR" || { echo "âŒ é”™è¯¯: ä»Ž Git å…‹éš†å¤±è´¥ã€‚"; exit 1; }
    cd "$PROJECT_DIR" || { echo "âŒ é”™è¯¯: æ— æ³•è¿›å…¥é¡¹ç›®ç›®å½• '$PROJECT_DIR'ã€‚"; exit 1; }
else
    echo "è¿›å…¥é¡¹ç›®ç›®å½•: $PROJECT_DIR"
    cd "$PROJECT_DIR" || { echo "âŒ é”™è¯¯: æ— æ³•è¿›å…¥é¡¹ç›®ç›®å½• '$PROJECT_DIR'ã€‚"; exit 1; }
    echo "æ­£åœ¨ä»Ž Git æ‹‰å–æœ€æ–°ä»£ç ..."
    git pull || { echo "âŒ é”™è¯¯: Git pull å¤±è´¥ã€‚"; exit 1; }
fi

# 3. è‡ªåŠ¨åˆ›å»º/éªŒè¯ .env.production æ–‡ä»¶
ENV_FILE=".env.production"
if [ ! -f "$ENV_FILE" ]; then
    echo "ç”Ÿäº§çŽ¯å¢ƒé…ç½®æ–‡ä»¶ '$ENV_FILE' ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
    tee "$ENV_FILE" > /dev/null <<EOF
# Auto-generated by deploy.sh
DATABASE_URL="file:./prod.db"
NEXT_TELEMETRY_DISABLED=1
EOF
    echo "âœ… '$ENV_FILE' åˆ›å»ºæˆåŠŸã€‚"
else
    echo "âœ… '$ENV_FILE' æ–‡ä»¶å·²å­˜åœ¨ã€‚"
fi

# 4. å®‰è£…/æ›´æ–° Node.js ç”Ÿäº§ä¾èµ–
echo "ðŸ“¦ å®‰è£… npm ç”Ÿäº§ä¾èµ–..."
npm install --production || { echo "âŒ é”™è¯¯: npm install å¤±è´¥ã€‚"; exit 1; }

# 5. åº”ç”¨æ•°æ®åº“è¿ç§»
echo "ðŸ—„ï¸ åº”ç”¨ Prisma æ•°æ®åº“è¿ç§»..."
npx prisma migrate deploy || { echo "âŒ é”™è¯¯: Prisma è¿ç§»å¤±è´¥ã€‚"; exit 1; }

# 6. æž„å»º Next.js åº”ç”¨
echo "ðŸ—ï¸  æ­£åœ¨æž„å»º Next.js åº”ç”¨..."
npm run build || { echo "âŒ é”™è¯¯: æž„å»ºå¤±è´¥ã€‚"; exit 1; }

# 7. ä½¿ç”¨ PM2 å¯åŠ¨æˆ–é‡å¯åº”ç”¨
echo "ðŸ”„ ä½¿ç”¨ PM2 å¯åŠ¨/é‡å¯åº”ç”¨..."
if pm2 list | grep -q "$APP_NAME"; then
    pm2 reload "$APP_NAME" --exp-backoff-restart-delay=100 || { echo "âŒ é”™è¯¯: PM2 é‡å¯å¤±è´¥ã€‚"; exit 1; }
else
    # ç¬¬ä¸€æ¬¡å¯åŠ¨
    pm2 start npm --name "$APP_NAME" -- start || { echo "âŒ é”™è¯¯: PM2 å¯åŠ¨å¤±è´¥ã€‚"; exit 1; }
fi

# ä¿å­˜ PM2 è¿›ç¨‹åˆ—è¡¨ï¼Œä»¥ä¾¿æœåŠ¡å™¨é‡å¯åŽè‡ªåŠ¨æ¢å¤
pm2 save || { echo "âŒ é”™è¯¯: PM2 ä¿å­˜è¿›ç¨‹åˆ—è¡¨å¤±è´¥ã€‚"; exit 1; }

echo ""
echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼"
echo "   åº”ç”¨ '$APP_NAME' æ­£åœ¨è¿è¡Œä¸­ã€‚"
echo "   ä½¿ç”¨ 'pm2 list' æŸ¥çœ‹çŠ¶æ€ã€‚"
echo "   ä½¿ç”¨ 'pm2 logs $APP_NAME' æŸ¥çœ‹å®žæ—¶æ—¥å¿—ã€‚"
